{% extends "base.html" %}

{% block title %}Recommendations - Ads Control Tower{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Recommendations</h1>
            <p class="mt-1 text-sm text-gray-500">Review and approve optimization suggestions for {{ date }}</p>
        </div>
        <div>
            <input type="date" id="dateSelector" value="{{ date }}" 
                   class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                   onchange="window.location.href='/recommendations/' + this.value">
        </div>
    </div>
    
    {% if error %}
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
            <p class="text-sm text-yellow-700">{{ error }}</p>
            <p class="text-sm text-yellow-700 mt-2">
                <a href="/recommendations" class="underline">View today's recommendations</a> or select a different date.
            </p>
        </div>
    {% else %}
        <!-- Summary -->
        {% if summary %}
        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div>
                    <p class="text-sm text-gray-500">Total</p>
                    <p class="text-2xl font-bold text-gray-900">{{ summary.total_recommendations }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Low Risk</p>
                    <p class="text-2xl font-bold text-green-600">{{ summary.low_risk }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Medium Risk</p>
                    <p class="text-2xl font-bold text-yellow-600">{{ summary.medium_risk }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">High Risk</p>
                    <p class="text-2xl font-bold text-red-600">{{ summary.high_risk }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Executable</p>
                    <p class="text-2xl font-bold text-blue-600">{{ summary.executable }}</p>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Low Risk Recommendations -->
        {% if low_risk %}
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">
                    <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                    Low Risk ({{ low_risk|length }})
                </h2>
                <!-- Batch Execute Buttons -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500" id="low-risk-selected-count">0 selected</span>
                    <button onclick="executeBatch('low-risk', true)" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            id="low-risk-batch-dry-run" disabled>
                        Dry-Run Selected
                    </button>
                    <button onclick="executeBatch('low-risk', false)" 
                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            id="low-risk-batch-live" disabled>
                        Execute Selected
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                {% for rec in low_risk %}
                <div class="border border-gray-200 rounded-lg p-4 {% if rec.approved %}bg-green-50 border-green-300{% elif rec.rejected %}bg-red-50 border-red-300{% endif %}" 
                     id="rec-{{ rec.id }}">
                    <div class="flex items-start justify-between">
                        <!-- Checkbox for batch selection -->
                        <div class="flex-shrink-0 mr-3 pt-1">
                            <input type="checkbox" class="low-risk-checkbox w-4 h-4 text-blue-600 rounded" 
                                   data-rec-id="{{ rec.id }}" onchange="updateBatchButtons('low-risk')">
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">{{ rec.rule_name }}</h3>
                            <p class="text-sm text-gray-600 mt-1">Campaign: {{ rec.campaign_name or rec.entity_id }}</p>
                            {% if rec.current_value is not none and rec.recommended_value is not none %}
                            <div class="mt-2 flex items-center space-x-4">
                                <span class="text-sm text-gray-500">
                                    Current: <strong>${{ "%.2f"|format(rec.current_value / 1000000) }}</strong>
                                </span>
                                <span class="text-gray-400">→</span>
                                <span class="text-sm text-gray-500">
                                    Proposed: <strong>${{ "%.2f"|format(rec.recommended_value / 1000000) }}</strong>
                                </span>
                                {% if rec.change_pct is not none %}
                                <span class="text-sm font-medium {% if rec.change_pct > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                    {{ "{:+.1f}".format(rec.change_pct * 100) }}%
                                </span>
                                {% endif %}
                            </div>
                            {% endif %}
                            <p class="text-sm text-gray-600 mt-2">{{ rec.rationale }}</p>
                            <p class="text-sm text-blue-600 mt-1">Expected: {{ rec.expected_impact }}</p>
                            
                            <!-- Error message area (inline) -->
                            <div id="error-{{ rec.id }}" class="text-sm text-red-600 mt-2 hidden"></div>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            {% if rec.approved %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                    ✓ Approved
                                </span>
                            {% elif rec.rejected %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                    ✗ Rejected
                                </span>
                            {% else %}
                                <div class="flex flex-col space-y-2">
                                    <!-- Execute buttons -->
                                    <div class="flex space-x-2">
                                        <button onclick="executeRecommendation({{ rec.id }}, true)" 
                                                id="btn-dry-{{ rec.id }}"
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium">
                                            Dry-Run
                                        </button>
                                        <button onclick="executeRecommendation({{ rec.id }}, false)" 
                                                id="btn-live-{{ rec.id }}"
                                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium">
                                            Execute Live
                                        </button>
                                    </div>
                                    <!-- Approve/Reject buttons -->
                                    <div class="flex space-x-2">
                                        <button onclick="approveRec('{{ date }}', '{{ rec.rule_id }}', '{{ rec.entity_id }}', '{{ rec.campaign_name or "N/A" }}', '{{ rec.action_type }}')"
                                                class="px-3 py-1 bg-gray-200 text-gray-700 text-xs font-medium rounded hover:bg-gray-300">
                                            Approve
                                        </button>
                                        <button onclick="rejectRec('{{ date }}', '{{ rec.rule_id }}', '{{ rec.entity_id }}', '{{ rec.campaign_name or "N/A" }}', '{{ rec.action_type }}')"
                                                class="px-3 py-1 bg-gray-200 text-gray-700 text-xs font-medium rounded hover:bg-gray-300">
                                            Reject
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Medium Risk Recommendations -->
        {% if medium_risk %}
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">
                    <span class="inline-block w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                    Medium Risk ({{ medium_risk|length }})
                </h2>
                <!-- Batch Execute Buttons -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500" id="medium-risk-selected-count">0 selected</span>
                    <button onclick="executeBatch('medium-risk', true)" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            id="medium-risk-batch-dry-run" disabled>
                        Dry-Run Selected
                    </button>
                    <button onclick="executeBatch('medium-risk', false)" 
                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            id="medium-risk-batch-live" disabled>
                        Execute Selected
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                {% for rec in medium_risk %}
                <div class="border border-gray-200 rounded-lg p-4 {% if rec.approved %}bg-green-50 border-green-300{% elif rec.rejected %}bg-red-50 border-red-300{% endif %}" 
                     id="rec-{{ rec.id }}">
                    <div class="flex items-start justify-between">
                        <!-- Checkbox for batch selection -->
                        <div class="flex-shrink-0 mr-3 pt-1">
                            <input type="checkbox" class="medium-risk-checkbox w-4 h-4 text-blue-600 rounded" 
                                   data-rec-id="{{ rec.id }}" onchange="updateBatchButtons('medium-risk')">
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">{{ rec.rule_name }}</h3>
                            <p class="text-sm text-gray-600 mt-1">Campaign: {{ rec.campaign_name or rec.entity_id }}</p>
                            {% if rec.current_value is not none and rec.recommended_value is not none %}
                            <div class="mt-2 flex items-center space-x-4">
                                <span class="text-sm text-gray-500">
                                    Current: <strong>${{ "%.2f"|format(rec.current_value / 1000000) }}</strong>
                                </span>
                                <span class="text-gray-400">→</span>
                                <span class="text-sm text-gray-500">
                                    Proposed: <strong>${{ "%.2f"|format(rec.recommended_value / 1000000) }}</strong>
                                </span>
                                {% if rec.change_pct is not none %}
                                <span class="text-sm font-medium {% if rec.change_pct > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                    {{ "{:+.1f}".format(rec.change_pct * 100) }}%
                                </span>
                                {% endif %}
                            </div>
                            {% endif %}
                            <p class="text-sm text-gray-600 mt-2">{{ rec.rationale }}</p>
                            <p class="text-sm text-blue-600 mt-1">Expected: {{ rec.expected_impact }}</p>
                            
                            <!-- Error message area (inline) -->
                            <div id="error-{{ rec.id }}" class="text-sm text-red-600 mt-2 hidden"></div>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            {% if rec.approved %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                    ✓ Approved
                                </span>
                            {% elif rec.rejected %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                    ✗ Rejected
                                </span>
                            {% else %}
                                <div class="flex flex-col space-y-2">
                                    <!-- Execute buttons -->
                                    <div class="flex space-x-2">
                                        <button onclick="executeRecommendation({{ rec.id }}, true)" 
                                                id="btn-dry-{{ rec.id }}"
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium">
                                            Dry-Run
                                        </button>
                                        <button onclick="executeRecommendation({{ rec.id }}, false)" 
                                                id="btn-live-{{ rec.id }}"
                                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium">
                                            Execute Live
                                        </button>
                                    </div>
                                    <!-- Approve/Reject buttons -->
                                    <div class="flex space-x-2">
                                        <button onclick="approveRec('{{ date }}', '{{ rec.rule_id }}', '{{ rec.entity_id }}', '{{ rec.campaign_name or "N/A" }}', '{{ rec.action_type }}')"
                                                class="px-3 py-1 bg-gray-200 text-gray-700 text-xs font-medium rounded hover:bg-gray-300">
                                            Approve
                                        </button>
                                        <button onclick="rejectRec('{{ date }}', '{{ rec.rule_id }}', '{{ rec.entity_id }}', '{{ rec.campaign_name or "N/A" }}', '{{ rec.action_type }}')"
                                                class="px-3 py-1 bg-gray-200 text-gray-700 text-xs font-medium rounded hover:bg-gray-300">
                                            Reject
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- High Risk Recommendations -->
        {% if high_risk %}
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                    High Risk ({{ high_risk|length }})
                </h2>
                <!-- Batch Execute Buttons -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500" id="high-risk-selected-count">0 selected</span>
                    <button onclick="executeBatch('high-risk', true)" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            id="high-risk-batch-dry-run" disabled>
                        Dry-Run Selected
                    </button>
                    <button onclick="executeBatch('high-risk', false)" 
                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                            id="high-risk-batch-live" disabled>
                        Execute Selected
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                {% for rec in high_risk %}
                <div class="border border-gray-200 rounded-lg p-4 {% if rec.approved %}bg-green-50 border-green-300{% elif rec.rejected %}bg-red-50 border-red-300{% endif %}" 
                     id="rec-{{ rec.id }}">
                    <div class="flex items-start justify-between">
                        <!-- Checkbox for batch selection -->
                        <div class="flex-shrink-0 mr-3 pt-1">
                            <input type="checkbox" class="high-risk-checkbox w-4 h-4 text-blue-600 rounded" 
                                   data-rec-id="{{ rec.id }}" onchange="updateBatchButtons('high-risk')">
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">{{ rec.rule_name }}</h3>
                            <p class="text-sm text-gray-600 mt-1">Campaign: {{ rec.campaign_name or rec.entity_id }}</p>
                            {% if rec.current_value is not none and rec.recommended_value is not none %}
                            <div class="mt-2 flex items-center space-x-4">
                                <span class="text-sm text-gray-500">
                                    Current: <strong>${{ "%.2f"|format(rec.current_value / 1000000) }}</strong>
                                </span>
                                <span class="text-gray-400">→</span>
                                <span class="text-sm text-gray-500">
                                    Proposed: <strong>${{ "%.2f"|format(rec.recommended_value / 1000000) }}</strong>
                                </span>
                                {% if rec.change_pct is not none %}
                                <span class="text-sm font-medium {% if rec.change_pct > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                    {{ "{:+.1f}".format(rec.change_pct * 100) }}%
                                </span>
                                {% endif %}
                            </div>
                            {% endif %}
                            <p class="text-sm text-gray-600 mt-2">{{ rec.rationale }}</p>
                            <p class="text-sm text-blue-600 mt-1">Expected: {{ rec.expected_impact }}</p>
                            
                            <!-- Error message area (inline) -->
                            <div id="error-{{ rec.id }}" class="text-sm text-red-600 mt-2 hidden"></div>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            {% if rec.approved %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                    ✓ Approved
                                </span>
                            {% elif rec.rejected %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                    ✗ Rejected
                                </span>
                            {% else %}
                                <div class="flex flex-col space-y-2">
                                    <!-- Execute buttons -->
                                    <div class="flex space-x-2">
                                        <button onclick="executeRecommendation({{ rec.id }}, true)" 
                                                id="btn-dry-{{ rec.id }}"
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium">
                                            Dry-Run
                                        </button>
                                        <button onclick="executeRecommendation({{ rec.id }}, false)" 
                                                id="btn-live-{{ rec.id }}"
                                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium">
                                            Execute Live
                                        </button>
                                    </div>
                                    <!-- Approve/Reject buttons -->
                                    <div class="flex space-x-2">
                                        <button onclick="approveRec('{{ date }}', '{{ rec.rule_id }}', '{{ rec.entity_id }}', '{{ rec.campaign_name or "N/A" }}', '{{ rec.action_type }}')"
                                                class="px-3 py-1 bg-gray-200 text-gray-700 text-xs font-medium rounded hover:bg-gray-300">
                                            Approve
                                        </button>
                                        <button onclick="rejectRec('{{ date }}', '{{ rec.rule_id }}', '{{ rec.entity_id }}', '{{ rec.campaign_name or "N/A" }}', '{{ rec.action_type }}')"
                                                class="px-3 py-1 bg-gray-200 text-gray-700 text-xs font-medium rounded hover:bg-gray-300">
                                            Reject
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if not low_risk and not medium_risk and not high_risk %}
        <div class="bg-white shadow rounded-lg p-6">
            <p class="text-gray-500 text-center">No recommendations available for this date</p>
        </div>
        {% endif %}
    {% endif %}
</div>

<script>
// ==================== EXISTING APPROVE/REJECT FUNCTIONS ====================
function approveRec(date, ruleId, entityId, campaignName, actionType) {
    fetch('/api/approve', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            date: date,
            rule_id: ruleId,
            entity_id: entityId,
            campaign_name: campaignName,
            action_type: actionType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function rejectRec(date, ruleId, entityId, campaignName, actionType) {
    fetch('/api/reject', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            date: date,
            rule_id: ruleId,
            entity_id: entityId,
            campaign_name: campaignName,
            action_type: actionType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// ==================== NEW EXECUTION FUNCTIONS ====================

// Execute a single recommendation
function executeRecommendation(recId, dryRun) {
    // Get current date
    const dateStr = document.getElementById('dateSelector').value;
    
    // Disable buttons during execution
    const dryBtn = document.getElementById(`btn-dry-${recId}`);
    const liveBtn = document.getElementById(`btn-live-${recId}`);
    const originalDryText = dryBtn.textContent;
    const originalLiveText = liveBtn.textContent;
    
    dryBtn.disabled = true;
    liveBtn.disabled = true;
    
    if (dryRun) {
        dryBtn.textContent = 'Running...';
    } else {
        liveBtn.textContent = 'Executing...';
    }
    
    // Clear any previous error
    const errorDiv = document.getElementById(`error-${recId}`);
    errorDiv.classList.add('hidden');
    errorDiv.textContent = '';
    
    // Function to actually execute
    const executeNow = () => {
        fetch('/api/execute-recommendation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                recommendation_id: recId,
                date_str: dateStr,
                dry_run: dryRun
            })
        })
        .then(response => response.json())
        .then(data => {
            // Re-enable buttons
            dryBtn.disabled = false;
            liveBtn.disabled = false;
            dryBtn.textContent = originalDryText;
            liveBtn.textContent = originalLiveText;
            
            if (data.success) {
                // Show success toast
                const mode = dryRun ? 'Dry-run' : 'Live execution';
                showToast(`${mode} successful: ${data.message}`, 'success', 3000);
            } else {
                // Show error inline (Q4: A)
                errorDiv.textContent = `Error: ${data.error || data.message}`;
                errorDiv.classList.remove('hidden');
                
                // Also show error toast
                showToast(`Execution failed: ${data.error || data.message}`, 'error', 5000);
            }
        })
        .catch(error => {
            // Re-enable buttons
            dryBtn.disabled = false;
            liveBtn.disabled = false;
            dryBtn.textContent = originalDryText;
            liveBtn.textContent = originalLiveText;
            
            // Show error
            const errorMsg = `Execution failed: ${error.message}`;
            errorDiv.textContent = errorMsg;
            errorDiv.classList.remove('hidden');
            showToast(errorMsg, 'error', 5000);
        });
    };
    
    // Q2: B - Only show modal for live execution
    if (!dryRun) {
        showConfirmModal(
            'Execute this recommendation LIVE? This will modify your Google Ads account.',
            executeNow,
            'Confirm Live Execution'
        );
    } else {
        executeNow();
    }
}

// Execute batch recommendations
function executeBatch(riskTier, dryRun) {
    const checkboxes = document.querySelectorAll(`.${riskTier}-checkbox:checked`);
    const recIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.recId));
    
    if (recIds.length === 0) {
        showToast('No recommendations selected', 'error', 3000);
        return;
    }
    
    // Get current date
    const dateStr = document.getElementById('dateSelector').value;
    
    // Disable batch buttons
    const dryBtn = document.getElementById(`${riskTier}-batch-dry-run`);
    const liveBtn = document.getElementById(`${riskTier}-batch-live`);
    const originalDryText = dryBtn.textContent;
    const originalLiveText = liveBtn.textContent;
    
    dryBtn.disabled = true;
    liveBtn.disabled = true;
    
    if (dryRun) {
        dryBtn.textContent = 'Running...';
    } else {
        liveBtn.textContent = 'Executing...';
    }
    
    // Function to actually execute
    const executeNow = () => {
        fetch('/api/execute-batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                recommendation_ids: recIds,
                date_str: dateStr,
                dry_run: dryRun
            })
        })
        .then(response => response.json())
        .then(data => {
            // Re-enable buttons
            dryBtn.disabled = false;
            liveBtn.disabled = false;
            dryBtn.textContent = originalDryText;
            liveBtn.textContent = originalLiveText;
            
            if (data.success) {
                const summary = data.summary;
                const mode = dryRun ? 'Dry-run' : 'Live execution';
                showToast(`${mode} complete: ${summary.succeeded} succeeded, ${summary.failed} failed`, 'success', 5000);
                
                // Show individual results
                data.results.forEach(result => {
                    const errorDiv = document.getElementById(`error-${result.recommendation_id}`);
                    if (!result.success) {
                        // Show error inline
                        errorDiv.textContent = `Error: ${result.message}`;
                        errorDiv.classList.remove('hidden');
                    } else {
                        // Clear error if shown
                        errorDiv.classList.add('hidden');
                    }
                });
                
                // Uncheck all checkboxes
                checkboxes.forEach(cb => cb.checked = false);
                updateBatchButtons(riskTier);
            } else {
                showToast(`Batch execution failed: ${data.message}`, 'error', 5000);
            }
        })
        .catch(error => {
            // Re-enable buttons
            dryBtn.disabled = false;
            liveBtn.disabled = false;
            dryBtn.textContent = originalDryText;
            liveBtn.textContent = originalLiveText;
            
            showToast(`Batch execution failed: ${error.message}`, 'error', 5000);
        });
    };
    
    // Q2: B - Only show modal for live execution
    if (!dryRun) {
        showConfirmModal(
            `Execute ${recIds.length} recommendations LIVE? This will modify your Google Ads account.`,
            executeNow,
            'Confirm Batch Execution'
        );
    } else {
        executeNow();
    }
}

// Update batch button states based on checkbox selection
function updateBatchButtons(riskTier) {
    const checkboxes = document.querySelectorAll(`.${riskTier}-checkbox:checked`);
    const count = checkboxes.length;
    
    const countSpan = document.getElementById(`${riskTier}-selected-count`);
    const dryBtn = document.getElementById(`${riskTier}-batch-dry-run`);
    const liveBtn = document.getElementById(`${riskTier}-batch-live`);
    
    countSpan.textContent = `${count} selected`;
    
    if (count > 0) {
        dryBtn.disabled = false;
        liveBtn.disabled = false;
    } else {
        dryBtn.disabled = true;
        liveBtn.disabled = true;
    }
}
</script>
{% endblock %}
